#!/bin/sh

# 设置背景色
xsetroot -solid "#333333" &

# 设置键盘速率 - 更适合Wine的参数
xset r rate 500 15 &

# 禁用自动重复键 - 关键修复
xset -r &

# 重置X的输入设备
xinput list 2>/dev/null | grep -i keyboard | grep -o 'id=[0-9]*' | cut -d= -f2 | while read id; do
  xinput disable $id 2>/dev/null || true
  sleep 0.2
  xinput enable $id 2>/dev/null || true
done &

# 启动会话监控脚本 - 防止会话终止
/etc/X11/xinit/xinitrc.d/99-session-fix.sh &

# 延迟后启动MetaTrader，确保环境已经完全就绪
(
    # 设置Wine环境变量
    export WINEPREFIX=/root/.wine
    export WINEARCH=win64
    export DISPLAY=:0
    
    # 等待环境准备好
    sleep 3
    
    # 配置Wine输入
    wine reg add "HKEY_CURRENT_USER\\Control Panel\\Input Method" /v "EnableHexNumpad" /t REG_SZ /d "1" /f
    wine reg add "HKEY_CURRENT_USER\\Software\\Wine\\X11 Driver" /v "GrabFullscreen" /t REG_SZ /d "N" /f
    wine reg add "HKEY_CURRENT_USER\\Software\\Wine\\X11 Driver" /v "UseTakeFocus" /t REG_SZ /d "Y" /f
    wine reg add "HKEY_CURRENT_USER\\Software\\Wine\\X11 Driver" /v "UseXIM" /t REG_SZ /d "Y" /f
    wine reg add "HKEY_CURRENT_USER\\Software\\Wine\\X11 Driver" /v "Decorated" /t REG_SZ /d "Y" /f
    wine reg add "HKEY_CURRENT_USER\\Software\\Wine\\X11 Driver" /v "Managed" /t REG_SZ /d "Y" /f
    wine reg add "HKEY_CURRENT_USER\\Software\\Wine\\X11 Driver" /v "DXGrab" /t REG_SZ /d "N" /f
    
    # 添加键盘响应参数
    wine reg add "HKEY_CURRENT_USER\\Control Panel\\Keyboard" /v "KeyboardDelay" /t REG_SZ /d "1" /f
    wine reg add "HKEY_CURRENT_USER\\Control Panel\\Keyboard" /v "KeyboardSpeed" /t REG_SZ /d "0.5" /f
    wine reg add "HKEY_CURRENT_USER\\Control Panel\\Accessibility\\Keyboard Response" /v "AutoRepeatDelay" /t REG_SZ /d "1000" /f
    wine reg add "HKEY_CURRENT_USER\\Control Panel\\Accessibility\\Keyboard Response" /v "AutoRepeatRate" /t REG_SZ /d "500" /f
    wine reg add "HKEY_CURRENT_USER\\Software\\Wine\\DirectInput" /v "MouseWarpOverride" /t REG_SZ /d "disable" /f
    
    # 启动MetaTrader
cd /root/Metatrader 
# 添加/nomousegrab参数防止鼠标被锁定
exec wine terminal64.exe /portable /nomousegrab
) &

# 确保脚本不退出 - 这是保持会话活跃的关键
# 如果这个脚本退出，Openbox会话将终止，导致用户被踢回登录界面
tail -f /dev/null
